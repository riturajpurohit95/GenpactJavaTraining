package com.ShopSphere.shop_sphere.service;

import java.util.List;

import org.springframework.stereotype.Service;

import com.ShopSphere.shop_sphere.exception.ResourceNotFoundException;
import com.ShopSphere.shop_sphere.model.Order;
import com.ShopSphere.shop_sphere.repository.OrderDao;

@Service
public class OrderServiceImpl implements OrderService {

	private final OrderDao orderDao;
	
	public OrderServiceImpl(OrderDao orderDao) {
		this.orderDao = orderDao;
	}
	
	@Override
	public Order createOrder(Order order) {
		if(order == null) {
			throw new IllegalArgumentException("Order must not be null");
		}
		int rows = orderDao.save(order);
		if(rows <=0) {
			throw new RuntimeException("Create failed for order of userId: "+ order.getUserId());
		}
		return order;
	}
	
	
	
	@Override
	public Order getOrderById(int orderId) {
		return orderDao.findById(orderId).orElseThrow(()-> new ResourceNotFoundException("Order not found with id: "+orderId));
	}
	
	@Override
	public List<Order> getOrdersByUserId(int userId){
		return orderDao.findByUserId(userId);
	}
	

	@Override
	public Order updateOrderStatus(int OrderId, String status) {
		Order existing = getOrderById(OrderId);
		
		
		int rows = orderDao.updateStatus(OrderId, status);
		if(rows <=0) {
			throw new RuntimeException("Update status failed for orderId: "+ OrderId);
		}
		existing.setStatus(status);
		return existing;
	}
	
	@Override
	public Order cancelOrder(int OrderId) {
		Order existing = getOrderById(OrderId);
		
		String currentStatus = existing.getStatus();
		if("DELIVERED".equalsIgnoreCase(currentStatus) || "REFUNDED".equalsIgnoreCase(currentStatus)) {
			throw new RuntimeException("Cannot cancel order in status: "+ currentStatus);
		}
		
		
		int rows = orderDao.cancelOrder(OrderId);
		if(rows <=0) {
			throw new RuntimeException("Cancel failed for orderId: "+ OrderId);
		}
		existing.setStatus("CANCELLED");
		return existing;
	}
	
	@Override
	public void deleteOrder(int OrderId) {
		getOrderById(OrderId);
		
		
		int rows = orderDao.deleteById(OrderId);
		if(rows <=0) {
			throw new RuntimeException("Delete failed for orderId: "+ OrderId);
		}
		
	}
	
	
	
	

	
}
