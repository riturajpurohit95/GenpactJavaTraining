
-- carts table 

-- 1. prevent duplicate cart

DELIMITER //

CREATE TRIGGER trg_prevent_duplicate_cart
BEFORE INSERT ON carts
FOR EACH ROW
BEGIN
	IF EXISTS (SELECT 1 FROM carts WHERE user_id = NEW.user_id)
	THEN 
	SIGNAL SQLSTATE '45000'
	SET MESSAGE_TEXT = 'User already has a cart';
	END IF;
END ;
//

DELIMITER ; 

-- cart_items table

-- 1. prevent adding same product twice in the same cart  -- filter in addItem() of CartItemDaoImpl

DELIMITER //

CREATE TRIGGER trg_cart_item_unique
BEFORE INSERT ON cart_items
FOR EACH ROW
BEGIN
	IF EXISTS (
	SELECT 1 FROM cart_items
	WHERE cart_id = NEW.cart_id AND 
	product_id = NEW.product_id)
	THEN 
	SIGNAL SQLSTATE '45000'
	SET MESSAGE_TEXT = 'Product already exists in cart';
	END IF;
END ;
//

DELIMITER ; 


-- 2. prevent zero or negative quantity

DELIMITER //

CREATE TRIGGER trg_cart_item_quantity_check
BEFORE INSERT ON cart_items
FOR EACH ROW
BEGIN
	IF NEW.quantity <= 0
	THEN 
	SIGNAL SQLSTATE '45000'
	SET MESSAGE_TEXT = 'Quantity must be greater than 0';
	END IF;
END ;
//

CREATE TRIGGER trg_cart_item_quantity_check_update
BEFORE UPDATE ON cart_items
FOR EACH ROW
BEGIN
	IF NEW.quantity <= 0
	THEN 
	SIGNAL SQLSTATE '45000'
	SET MESSAGE_TEXT = 'Quantity must be greater than 0';
	END IF;
END ;
//

DELIMITER ;


-- categories table

-- 1. prevent duplicate category names

DELIMITER //

CREATE TRIGGER trg_category_unique_name
BEFORE INSERT ON categories
FOR EACH ROW
BEGIN
	IF EXISTS (
	SELECT 1 FROM categories
	WHERE category_name = NEW.category_name)
	THEN 
	SIGNAL SQLSTATE '45000'
	SET MESSAGE_TEXT = 'Category name already exists';
	END IF;
END ;
//

CREATE TRIGGER trg_category_unique_name_update
BEFORE UPDATE ON categories
FOR EACH ROW
BEGIN
	IF EXISTS (
	SELECT 1 FROM categories
	WHERE category_name = NEW.category_name 
	AND category_id != NEW.category_id)
	THEN 
	SIGNAL SQLSTATE '45000'
	SET MESSAGE_TEXT = 'Category name already exists';
	END IF;
END ;
//

DELIMITER ;

-- 2. prevent deletion of category if products exist

DELIMITER //

CREATE TRIGGER trg_category_delete_check
BEFORE DELETE ON categories
FOR EACH ROW
BEGIN
	IF EXISTS (
	SELECT 1 FROM products
	WHERE category_id = OLD.category_id)
	THEN 
	SIGNAL SQLSTATE '45000'
	SET MESSAGE_TEXT = 'Cannot delete category with existing products';
	END IF;
END ;
//

DELIMITER ;



-------------------------------------------------------------------------------

-----------------------------------PRODUCT-------------------------------------------
-----check stock before placing order if enough stock available---
DELIMITER //
create trigger trg_check_stock_availability
befOre insert on order_items
for each row
BEGIN
	DECLARE available_stock int DEFAULT 0;
	select product_quantity into available_stock
	from products
	where product_id= NEW.product_id;
	if available_Stock < NEW.quantity then
	SIGNAL SQLSTATE '45000'
	SET MESSAGE_TEXT = 'Not enough stock stock available for this product';
	END IF;
END //


